var N=Object.defineProperty;var z=h=>{throw TypeError(h)};var $=(h,i,e)=>i in h?N(h,i,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[i]=e;var r=(h,i,e)=>$(h,typeof i!="symbol"?i+"":i,e),D=(h,i,e)=>i.has(h)||z("Cannot "+e);var d=(h,i,e)=>(D(h,i,"read from private field"),e?e.call(h):i.get(h)),g=(h,i,e)=>i.has(h)?z("Cannot add the same private member more than once"):i instanceof WeakSet?i.add(h):i.set(h,e),u=(h,i,e,s)=>(D(h,i,"write to private field"),s?s.call(h,e):i.set(h,e),e);(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(a){if(a.ep)return;a.ep=!0;const o=e(a);fetch(a.href,o)}})();const t="?",k="start",v="end",I="tower",G=(h,i)=>Math.sqrt(Math.pow(h.x-i.x,2)+Math.pow(h.y-i.y,2));var T;class A{constructor(){g(this,T);u(this,T,Math.floor(Math.random()*1e7))}get id(){return d(this,T)}}T=new WeakMap;var C;class q extends A{constructor({game:e,health:s,speed:a,damage:o,reward:n}){super();r(this,"game");r(this,"health");r(this,"maxHealth");r(this,"speed");g(this,C);r(this,"gridPosition");r(this,"nextPosition");r(this,"distance");r(this,"damage");r(this,"lastMoveTime",Date.now());r(this,"direction");r(this,"reward");r(this,"debuffs",[]);this.game=e,this.health=s,this.maxHealth=s,this.speed=a,u(this,C,a),this.distance=0,this.gridPosition=this.game.level.mapMatrix.getPathPosition(0),this.nextPosition=this.game.level.mapMatrix.getPathPosition(.5),this.direction=this.getDirection(this.nextPosition),this.damage=o,this.reward=n}getDirection(e){return this.gridPosition?e.col>this.gridPosition.col?"right":e.col<this.gridPosition.col?"left":e.row>this.gridPosition.row?"down":e.row<this.gridPosition.row?"up":"none":"none"}addDebuff(e){this.debuffs.push({...e,duration:Date.now()+e.duration})}applyDebuffs(){const e=Date.now();let s=d(this,C);this.debuffs=this.debuffs.filter(a=>!(e>a.duration)),this.debuffs.forEach(a=>{a.type==="freeze"&&(s/=2)}),this.speed=Math.max(s,.1)}update(){this.applyDebuffs();const e=Date.now(),a=(e-this.lastMoveTime)/1e3*this.speed,o=this.distance+a;Math.floor(o)>Math.floor(this.distance)&&(this.gridPosition=this.nextPosition,this.nextPosition=this.game.level.mapMatrix.getPathPosition(o)),this.nextPosition&&o%1>.5&&this.distance%1<=.5&&(this.direction=this.getDirection(this.nextPosition)),this.distance=o,this.lastMoveTime=e}getCanvasPosition(){if(!this.gridPosition)return null;const{row:e,col:s}=this.gridPosition,a=this.distance%1,{squareSize:o}=this.game,n=o/4;let l=s*o,c=e*o;return this.direction==="up"?(l+=o/2-n/2,c+=o-a*o):this.direction==="down"?(l+=o/2-n/2,c+=a*o):this.direction==="left"?(l+=o-a*o,c+=o/2-n/2):this.direction==="right"?(l+=a*o,c+=o/2-n/2):this.direction==="none"&&(l+=o/2-n/2,c+=o/2-n/2),{x:l,y:c}}render(){const e=this.getCanvasPosition();if(!e)return;const{squareSize:s,ctx:a}=this.game,o=s/3,{x:n,y:l}=e;a.fillStyle="black",a.fillRect(n,l,o,o),a.fillStyle="red",a.fillRect(n,l-10,o,5),a.fillStyle="green",a.fillRect(n,l-10,o*this.health/this.maxHealth,5)}takeDamage(e){this.health-=e,this.health<0&&(this.health=0)}isAlive(){return this.health>0}}C=new WeakMap;class E extends A{constructor({game:e,speed:s,damage:a,target:o,position:n}){super();r(this,"game");r(this,"speed");r(this,"damage");r(this,"target");r(this,"position");r(this,"lastMoveTime");r(this,"angle");r(this,"height",10);r(this,"width",10);r(this,"images",["arrow"]);r(this,"splash",null);r(this,"debuffs",null);this.game=e,this.speed=s,this.damage=a,this.target=o,this.position=n,this.angle=0,this.lastMoveTime=Date.now()}impact(){var s;const e=this.target;e instanceof q&&(e.takeDamage(this.damage),(s=this.debuffs)==null||s.forEach(a=>{e.addDebuff(a)})),this.splash&&this.game.level.monsters.forEach(a=>{var l;if(e instanceof q&&a.id===e.id)return;const o=a.getCanvasPosition();if(!o)return;G(this.position,o)<=this.splash*this.game.squareSize&&(a.takeDamage(this.damage),(l=this.debuffs)==null||l.forEach(c=>{a.addDebuff(c)}))}),this.game.projectiles=this.game.projectiles.filter(a=>a.id!==this.id)}getImage(){const e=this.images.length,s=Math.floor(Date.now()/1e3%e),a=this.images[s];return this.game.images[a]}update(){this.speed=this.speed*1.05;const e=Date.now(),a=(e-this.lastMoveTime)/1e3*this.speed;let o;this.target instanceof q?o=this.target.getCanvasPosition():o=this.game.convertGridPositionToCoordinates(this.target);const n=Math.sqrt(Math.pow(o.x-this.position.x,2)+Math.pow(o.y-this.position.y,2));if(a>n){this.position=o,this.lastMoveTime=e,this.impact();return}const l=Math.atan2(o.y-this.position.y,o.x-this.position.x),c=Math.cos(l)*a,m=Math.sin(l)*a;this.angle=l+Math.PI,this.position={x:this.position.x+c,y:this.position.y+m},this.lastMoveTime=e}render(){const{ctx:e}=this.game;e.save(),e.translate(this.position.x,this.position.y),e.rotate(this.angle);try{e.drawImage(this.getImage(),-this.width/2,-this.height/2,this.width,this.height)}catch(s){console.log(s)}e.restore()}}class j extends E{constructor({game:e,target:s,position:a,damage:o,speed:n}){super({game:e,speed:n,damage:o,target:s,position:a});r(this,"height",10);r(this,"width",25)}}class S extends A{constructor(e,s){super();r(this,"game");r(this,"gridPosition");r(this,"range",4);r(this,"damage",25);r(this,"attackSpeed",1);r(this,"lastAttackTime",Date.now());r(this,"placed",!1);r(this,"type","basic");this.game=e,this.gridPosition=s}render(){const{squareSize:e}=this.game,{col:s,row:a}=this.gridPosition,o=s*e,n=a*e,l=this.game.images[`tower-${this.type}`];try{this.game.ctx.drawImage(l,o,n,e,e)}catch(c){console.error(c)}}update(){this.attack()}getTargetsInRange(){const{monsters:e}=this.game.level,{col:s,row:a}=this.gridPosition;return e.find(o=>{if(!o.gridPosition||!o.isAlive())return!1;const n=o.gridPosition.col,l=o.gridPosition.row,c=Math.sqrt(Math.pow(n-s,2)+Math.pow(l-a,2));return Math.abs(c)<=this.range})}canAttack(){return Date.now()-this.lastAttackTime>1e3/this.attackSpeed}attack(){const e=Date.now();if(this.canAttack()){const s=this.getTargetsInRange();s&&(this.game.projectiles.push(new j({game:this.game,target:s,position:this.game.convertGridPositionToCoordinates(this.gridPosition),damage:this.damage,speed:250})),this.lastAttackTime=e)}}}class U extends S{constructor(){super(...arguments);r(this,"range",5);r(this,"damage",25);r(this,"attackSpeed",2);r(this,"type","arrow")}attack(){const e=Date.now();if(this.canAttack()){const s=this.getTargetsInRange();s&&(this.game.projectiles.push(new j({game:this.game,target:s,position:this.game.convertGridPositionToCoordinates(this.gridPosition),damage:this.damage,speed:500})),this.lastAttackTime=e)}}}class F extends E{constructor({game:e,target:s,position:a,damage:o}){super({game:e,speed:100,damage:o,target:s,position:a});r(this,"height",10);r(this,"width",25);r(this,"splash",1.5);r(this,"images",["bullet-1","bullet-2","bullet-3","bullet-4"])}}class _ extends S{constructor(){super(...arguments);r(this,"range",5);r(this,"damage",125);r(this,"attackSpeed",.75);r(this,"type","cannon")}attack(){const e=Date.now();if(this.canAttack()){const s=this.getTargetsInRange();s!=null&&s.gridPosition&&(this.game.projectiles.push(new F({game:this.game,target:s.gridPosition,position:this.game.convertGridPositionToCoordinates(this.gridPosition),damage:this.damage})),this.lastAttackTime=e)}}}class K extends E{constructor({game:e,target:s,position:a,damage:o}){super({game:e,speed:500,damage:o,target:s,position:a});r(this,"height",10);r(this,"width",25);r(this,"splash",.75);r(this,"images",["fire-1","fire-2"])}}class X extends S{constructor(){super(...arguments);r(this,"range",5);r(this,"damage",500);r(this,"attackSpeed",2.5);r(this,"type","fire")}attack(){const e=Date.now();if(this.canAttack()){const s=this.getTargetsInRange();s!=null&&s.gridPosition&&(this.game.projectiles.push(new K({game:this.game,target:s,position:this.game.convertGridPositionToCoordinates(this.gridPosition),damage:this.damage})),this.lastAttackTime=e)}}}const Y={freeze:"freeze"};class J extends E{constructor({game:e,target:s,position:a,damage:o}){super({game:e,speed:333,damage:o,target:s,position:a});r(this,"height",25);r(this,"width",25);r(this,"splash",1);r(this,"images",["frost-1","frost-2","frost-3","frost-4","frost-5","frost-6","frost-7","frost-8","frost-9","frost-10","frost-11","frost-12","frost-13"]);r(this,"debuffs",[{type:Y.freeze,duration:2e3}])}}class Q extends S{constructor(){super(...arguments);r(this,"range",5);r(this,"damage",50);r(this,"attackSpeed",1.5);r(this,"type","ice")}attack(){const e=Date.now();if(this.canAttack()){const s=this.getTargetsInRange();s!=null&&s.gridPosition&&(this.game.projectiles.push(new J({game:this.game,target:s,position:this.game.convertGridPositionToCoordinates(this.gridPosition),damage:this.damage})),this.lastAttackTime=e)}}}class V extends E{constructor({game:e,target:s,position:a,damage:o}){super({game:e,speed:800,damage:o,target:s,position:a});r(this,"height",15);r(this,"width",30);r(this,"images",["crystal"])}}class Z extends S{constructor(){super(...arguments);r(this,"range",10);r(this,"damage",1500);r(this,"attackSpeed",7.5);r(this,"type","mage")}attack(){const e=Date.now();if(this.canAttack()){const s=this.getTargetsInRange();s!=null&&s.gridPosition&&(this.game.projectiles.push(new V({game:this.game,target:s,position:this.game.convertGridPositionToCoordinates(this.gridPosition),damage:this.damage})),this.lastAttackTime=e)}}}const w={basic:50,arrow:100,cannon:200,fire:1e3,ice:500,mage:7500},tt={basic:"basic",arrow:"arrow",cannon:"cannon",fire:"fire",ice:"ice",mage:"mage"},O={basic:S,arrow:U,cannon:_,mage:Z,ice:Q,fire:X};class et{constructor(i){r(this,"game");r(this,"mousePosition");this.game=i,this.mousePosition={x:0,y:0},this.init()}getCellAtMousePosition(){const{x:i,y:e}=this.mousePosition,{squareSize:s}=this.game,a=Math.floor(i/s);return{row:Math.floor(e/s),col:a}}init(){this.game.canvas.addEventListener("mousemove",i=>{const e=this.game.canvas.getBoundingClientRect();this.mousePosition={x:i.clientX-e.left,y:i.clientY-e.top},this.game.hoveredCell=this.getCellAtMousePosition()}),this.game.canvas.addEventListener("click",()=>{this.handleClick()}),this.game.canvas.addEventListener("contextmenu",i=>{this.handleContextMenu(i)})}handleClick(){const i=this.getCellAtMousePosition();this.game.newTower&&this.game.level.mapMatrix.matrix[i.col][i.row]===t&&this.game.money>=w[this.game.newTower]&&(this.game.level.mapMatrix.matrix[i.col][i.row]=I,this.game.level.towers.push(new O[this.game.newTower](this.game,i)),this.game.money-=w[this.game.newTower],this.game.money<w[this.game.newTower]&&(this.game.newTower=null))}handleContextMenu(i){i.preventDefault();const e=this.getCellAtMousePosition();if(this.game.newTower)this.game.newTower=null;else if(this.game.level.mapMatrix.matrix[e.col][e.row]===I){const s=this.game.level.towers.find(a=>a.gridPosition.col===e.col&&a.gridPosition.row===e.row);s&&(this.game.paused=!0,confirm(`Sell for ${w[s.type]/2} coins?`)&&(this.game.money+=w[s.type]/2,this.game.level.towers=this.game.level.towers.filter(a=>a.id!==s.id),this.game.level.mapMatrix.matrix[e.col][e.row]=t),this.game.paused=!1)}}}const st=[[t,k,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t],[t,[1],t,[68],[67],[66],[65],[64],[63],[62],[61],[60],[59],[58],[57],[56],[55],[53],[52],t],[t,[2],t,[69],t,t,t,t,t,t,t,t,t,t,t,t,t,t,[51],t],[t,[3],t,[70],t,[120],[119],[118],[117],[116],[115],[114],[113],[112],[111],[110],[109],t,[50],t],[t,[4],t,[71],t,[121],t,t,t,t,t,t,t,t,t,t,[108],t,[49],t],[t,[5],t,[72],t,[122],t,[156],[155],[154],[153],[152],[151],[150],[149],t,[107],t,[48],t],[t,[6],t,[73],t,[123],t,[157],t,t,t,t,t,t,[148],t,[106],t,[47],t],[t,[7],t,[74],t,[124],t,[158],t,[176],[175],[174],[173],t,[147],t,[105],t,[46],t],[t,[8],t,[75],t,[125],t,[159],t,[177],v,[183],[172],t,[146],t,[104],t,[45],t],[t,[9],t,[76],t,[126],t,[160],t,[178],[181],[182],[171],t,[145],t,[103],t,[44],t],[t,[10],t,[77],t,[127],t,[161],t,[179],[180],t,[170],t,[144],t,[102],t,[43],t],[t,[11],t,[78],t,[128],t,[162],t,t,t,t,[169],t,[143],t,[101],t,[42],t],[t,[12],t,[79],t,[129],t,[163],[164],[165],[166],[167],[168],t,[142],t,[100],t,[41],t],[t,[13],t,[80],t,[130],t,t,t,t,t,t,t,t,[141],t,[99],t,[40],t],[t,[14],t,[81],t,[131],[132],[133],[134],[135],[136],[137],[138],[139],[140],t,[98],t,[39],t],[t,[15],t,[82],t,t,t,t,t,t,t,t,t,t,t,t,[97],t,[38],t],[t,[16],t,[83],[84],[85],[86],[87],[88],[89],[90],[91],[92],[93],[94],[95],[96],t,[37],t],[t,[17],t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,[36],t],[t,[18],[19],[20],[21],[22],[23],[24],[25],[26],[27],[28],[29],[30],[31],[32],[33],[34],[35],t],[t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t]],it=h=>{const i=document.createElement("div");i.id="toolbar-top";const e=document.createElement("button");e.id="start-wave",e.innerHTML="Start Wave",e.addEventListener("click",()=>{h.startWave()}),i.innerHTML=`
    <div class="toolbar-item">
      <span>🪙: </span>
      <span id="money" class="money">${h.money.toLocaleString("en-US")}</span>
    </div>
    <div class="toolbar-item">
      <span>❤️: </span>
      <span id="health">10</span>
    </div>
    <div class="toolbar-item">
      <span>🌊: </span>
      <span id="wave">0</span>
    </div>
    <div class="toolbar-item">
      <span>👿: </span>
      <span id="monsters">0</span>
    </div>
     <div class="toolbar-item">
      <span>💀: </span>
      <span id="kills">0</span>
    </div>
  `,i.appendChild(e);const s=document.createElement("label");s.innerHTML=`
    <input type="checkbox" id="automode" />
    <span>Auto mode</span>
  `,i.appendChild(s),document.body.insertBefore(i,document.body.firstChild);const a=document.createElement("div");a.id="toolbar-bottom",Object.values(tt).forEach(n=>{const l=document.createElement("button");l.innerHTML=`
    <img src="assets/tower-${n}.png" alt="${n} tower" />
    <span>${n} tower - <span class="price">${w[n].toLocaleString("en-US")}🪙</span></span>
    `,l.addEventListener("click",()=>{h.newTower=n}),a.appendChild(l)}),document.body.appendChild(a);const o=document.createElement("div");o.id="info-panel",o.innerHTML=`
  <details>
  <summary>How to play</summary>
  <h2>Goal</h2>
  <p>Defend your base from waves of monsters by building towers. The monsters move from the blue square(s) to the red square(s)</p>
  <h2>Adding towers</h2>
  <p>
    Use the toolbar at the bottom to select a tower type. Click on an empty square on the map to add a tower.
  </p>
  <h2>Selling towers</h2>
  <p>
    Right-click on a tower to sell it for half the price.
  </p>
  <h2>Starting a wave</h2>
  <p>
    Click the "Start Wave" button to start a new wave of monsters.
  </p>
  <h2>Auto mode</h2>
  <p>
    When auto mode is enabled, the game will automatically start new waves when the previous wave is defeated.
  </p>
  
  </details>
  
  `,document.body.appendChild(o)},at=h=>{const i=document.getElementById("health");i&&(i.innerText=h.toLocaleString("en-US"))},ot=h=>{const i=document.getElementById("kills");i&&(i.innerText=h.toLocaleString("en-US"))},rt=h=>{const i=document.getElementById("money");i&&(i.innerText=h.toLocaleString("en-US"))},R=h=>{const i=document.getElementById("monsters");i&&(i.innerText=h.toLocaleString("en-US"))},nt=h=>{const i=document.getElementById("wave");i&&(i.innerText=h.toLocaleString("en-US"))};class ht extends A{constructor(e,s){super();r(this,"matrix");r(this,"level");r(this,"totalDistance",0);this.level=e,this.matrix={},s?(this.matrix=s,Object.values(s).forEach(a=>{Object.values(a).forEach(o=>{Array.isArray(o)&&(this.totalDistance=Math.max(...o,this.totalDistance))})})):this.generateMapMatrix()}initMatrix(){var a,o;const{gridWidth:e,gridHeight:s}=this.level.game;this.matrix=Array.from({length:e},()=>Array(s).fill(t)),(a=this.level.startPositions)==null||a.forEach(n=>{this.matrix[n.row][n.col]=[0]}),(o=this.level.endPositions)==null||o.forEach(n=>{this.matrix[n.row][n.col]=v})}generateMapMatrix(){var e;(e=this.level.startPositions)==null||e.forEach(s=>{let a=0;do this.initMatrix(),this.totalDistance=this.buildPath(s.col,s.row,1),a++;while((this.totalDistance<this.level.minLength||this.totalDistance>this.level.maxLength)&&a<100);a>=100&&console.log("Failed to generate path")})}buildPath(e,s,a){const o=this.getNeighbors(e,s);if(o.some(({row:m,col:b})=>this.getCell(b,m)===v))return a;const n=o.filter(({col:m,row:b})=>this.canBePath(m,b,a));if(n.length===0)return-1;const l=n[Math.floor(Math.random()*n.length)],c=this.matrix[l.col][l.row];return Array.isArray(c)?c.push(a):this.matrix[l.col][l.row]=[a],this.buildPath(l.col,l.row,a+1)}getNeighbors(e,s){const a=[];return e>0&&a.push({col:e-1,row:s}),e<this.level.game.gridWidth-1&&a.push({col:e+1,row:s}),s>0&&a.push({col:e,row:s-1}),s<this.level.game.gridHeight-1&&a.push({col:e,row:s+1}),a}getCell(e,s){return this.matrix[e][s]}canBePath(e,s,a){const o=this.getCell(e,s);return!(o!==t&&Array.isArray(o)===!1||Array.isArray(o)&&o.some(l=>l>a-10)||this.getNeighbors(e,s).filter(({col:l,row:c})=>{const m=this.getCell(l,c);return Array.isArray(m)?!!m.some(b=>b>a-10):!1}).length>1||Array.isArray(o)&&o.length>=this.level.maxRepeatSquares)}getPathPosition(e){const s=Math.ceil(e);let a=s<0?this.level.startPositions[Math.random()*this.level.startPositions.length]:this.level.endPositions[0];return Object.keys(this.matrix).forEach(o=>{const n=Number(o);Object.keys(this.matrix[n]).forEach(l=>{const c=Number(l),m=this.matrix[n][c];if(Array.isArray(m)&&m.includes(s)){a={row:c,col:n};return}})}),a}}var x;class H extends A{constructor({game:e,startPositions:s,endPositions:a,minLength:o,maxLength:n,maxRepeatSquares:l,map:c}){super();r(this,"game");r(this,"startPositions");r(this,"endPositions");r(this,"mapMatrix");r(this,"minLength");r(this,"maxLength");r(this,"maxRepeatSquares");r(this,"towers",[]);r(this,"monsters",[]);g(this,x,0);this.game=e,this.startPositions=s,this.endPositions=a,this.minLength=o,this.maxLength=n,this.maxRepeatSquares=l,this.mapMatrix=new ht(this,c)}get wave(){return d(this,x)}set wave(e){u(this,x,e),nt(d(this,x))}}x=new WeakMap;var f,y,M,p,P;class lt{constructor(){g(this,f,10);g(this,y,100);g(this,M,0);r(this,"debug",!1);r(this,"canvas");r(this,"ctx");r(this,"squareSize",50);r(this,"gridWidth",25);r(this,"gridHeight",25);r(this,"level");r(this,"mouseHandler");r(this,"hoveredCell",null);r(this,"images",{});r(this,"tempCounter",-1);r(this,"projectiles",[]);g(this,p,null);g(this,P,!1);this.canvas=document.createElement("canvas");const i=this.canvas.getContext("2d");if(!i)throw new Error("2d context not supported");this.canvas.width=this.squareSize*this.gridWidth,this.canvas.height=this.squareSize*this.gridHeight,this.ctx=i,Math.random()>.5?this.level=new H({game:this,endPositions:[{col:8,row:10}],startPositions:[{col:0,row:1}],maxLength:200,maxRepeatSquares:1,minLength:100,map:st}):this.level=new H({game:this,endPositions:[{col:Math.floor(Math.random()*this.gridHeight/2),row:Math.floor(Math.random()*this.gridWidth/2)}],startPositions:[{col:Math.floor((Math.random()+.5)*this.gridHeight/2),row:Math.floor((Math.random()+.5)*this.gridWidth/2)}],maxLength:250,maxRepeatSquares:3,minLength:100}),document.body.appendChild(this.canvas),this.mouseHandler=new et(this),this.loadImages(),new URLSearchParams(window.location.search).has("debug")&&(this.debug=!0),it(this)}getNumberOfMonstersPerWave(){return 20+(this.level.wave-1)*2}startWave(){d(this,f)<=0||this.tempCounter<this.getNumberOfMonstersPerWave()&&this.tempCounter!==-1||(this.level.wave++,this.tempCounter=0,this.spawnMonsters())}spawnMonsters(){setTimeout(()=>{this.tempCounter<this.getNumberOfMonstersPerWave()&&(this.spawnMonster(),this.tempCounter++,this.spawnMonsters())},500/this.getSpeed())}getSpeed(){let i=1;return this.level.wave>5&&(i+=(this.level.wave-5)*.2),this.level.wave>10&&(i+=(this.level.wave-10)*.2),this.level.wave>15&&(i+=(this.level.wave-15)*.2),this.level.wave>20&&(i+=(this.level.wave-20)*.2),i}getHealth(){let i=100;return this.level.wave>3&&(i+=(this.level.wave-3)*15),this.level.wave>5&&(i+=(this.level.wave-5)*10),this.level.wave>10&&(i+=(this.level.wave-10)*25),this.level.wave>15&&(i+=(this.level.wave-15)*50),this.level.wave>20&&(i+=(this.level.wave-20)*100),i}spawnMonster(){this.level.monsters.push(new q({game:this,health:this.getHealth(),speed:this.getSpeed(),damage:1,reward:10+Math.floor(this.level.wave/2)})),R(this.level.monsters.length)}loadImages(){["tower-basic","tower-arrow","tower-cannon","tower-mage","tower-ice","tower-fire","arrow","bullet-1","bullet-2","bullet-3","bullet-4","fire-1","fire-2","frost-1","frost-2","frost-3","frost-4","frost-5","frost-6","frost-7","frost-8","frost-9","frost-10","frost-11","frost-12","frost-13","crystal"].forEach(e=>{const s=new Image;s.src=`./assets/${e}.png`,this.images[e]=s})}update(){var s;if(d(this,P))return;const i=this.level.monsters.filter(a=>a.distance>=this.level.mapMatrix.totalDistance),e=this.level.monsters.filter(a=>!a.isAlive());e.forEach(a=>{this.money+=a.reward,this.killCount++}),this.level.monsters=this.level.monsters.filter(a=>a.isAlive()&&a.distance<this.level.mapMatrix.totalDistance),i.forEach(a=>{console.log(`Monster reached the end, -${a.damage} health`),this.health-=a.damage}),this.level.monsters.forEach(a=>{a.update()}),this.level.towers.forEach(a=>{a.update()}),this.projectiles.forEach(a=>{a.update()}),d(this,f)<0&&confirm("Game Over! Play again?")&&window.location.reload(),(e.length>0||i.length>0)&&R(this.level.monsters.length),this.level.monsters.length===0&&(console.log(`Wave ${this.level.wave} completed!`),(s=document.getElementById("automode"))!=null&&s.checked&&this.startWave())}render(){this.drawGrid(),this.level.monsters.forEach(i=>{i.render()}),this.level.towers.forEach(i=>{i.render()}),this.projectiles.forEach(i=>{i.render()}),d(this,f)<=0&&(this.ctx.save(),this.ctx.fillStyle="red",this.ctx.font="30px Arial",this.ctx.textAlign="center",this.ctx.fillText("Game Over!",this.canvas.width/2,this.canvas.height/1.5),this.ctx.restore()),d(this,p)&&(this.ctx.save(),this.ctx.globalAlpha=.25,this.ctx.beginPath(),this.ctx.arc(this.hoveredCell.col*this.squareSize+this.squareSize/2,this.hoveredCell.row*this.squareSize+this.squareSize/2,d(this,p).range*this.squareSize,0,2*Math.PI),this.ctx.fillStyle="purple",this.ctx.globalAlpha=.5,d(this,p).gridPosition=this.hoveredCell,d(this,p).render(),this.ctx.fill(),this.ctx.restore())}drawGrid(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);const{matrix:i}=this.level.mapMatrix;Object.keys(i).forEach(e=>{const s=Number(e);Object.keys(i[s]).forEach(a=>{const o=Number(a),n=i[s][o];this.ctx.save(),typeof n=="string"?n===k?this.ctx.fillStyle="blue":n===v?this.ctx.fillStyle="rgba(255, 0, 0, 0.5)":n===t?this.ctx.fillStyle="green":this.ctx.fillStyle="green":Array.isArray(n)&&n.includes(0)?this.ctx.fillStyle="blue":Array.isArray(n)&&n.length>0&&(this.ctx.fillStyle="rgb(200, 200, 200)"),this.ctx.fillRect(s*this.squareSize,o*this.squareSize,this.squareSize,this.squareSize),this.debug&&(this.ctx.save(),this.ctx.fillStyle="black",this.ctx.font="12px Arial",Array.isArray(n)&&n.length>0?this.ctx.fillText(n.toString(),s*this.squareSize+5,o*this.squareSize+15):n===k?this.ctx.fillText(k,s*this.squareSize+5,o*this.squareSize+15):n===v&&this.ctx.fillText(v,s*this.squareSize+5,o*this.squareSize+15),this.ctx.font="10px Arial",this.ctx.fillText(`${s},${o}`,s*this.squareSize+20,o*this.squareSize+40),this.ctx.restore()),this.ctx.strokeStyle="lightgray",this.ctx.strokeRect(s*this.squareSize,o*this.squareSize,this.squareSize,this.squareSize),this.ctx.restore()})}),this.hoveredCell&&(this.ctx.save(),this.ctx.strokeStyle="gold",this.ctx.lineWidth=3,this.ctx.strokeRect(this.hoveredCell.col*this.squareSize,this.hoveredCell.row*this.squareSize,this.squareSize,this.squareSize),this.ctx.restore())}convertGridPositionToCoordinates(i){return{x:i.col*this.squareSize+this.squareSize/2,y:i.row*this.squareSize+this.squareSize/2}}get health(){return d(this,f)}set health(i){u(this,f,i),at(d(this,f))}get money(){return d(this,y)}set money(i){u(this,y,i),rt(d(this,y))}get killCount(){return d(this,M)}set killCount(i){u(this,M,i),ot(d(this,M))}get newTower(){var i;return((i=d(this,p))==null?void 0:i.type)||null}set newTower(i){u(this,p,i?new O[i](this,this.hoveredCell):null)}get paused(){return d(this,P)}set paused(i){const e=Date.now();this.level.towers.forEach(s=>{s.lastAttackTime=e}),this.level.monsters.forEach(s=>{s.lastMoveTime=e}),this.projectiles.forEach(s=>{s.lastMoveTime=e}),u(this,P,i)}}f=new WeakMap,y=new WeakMap,M=new WeakMap,p=new WeakMap,P=new WeakMap;const L=new lt,W=async()=>{L.render(),requestAnimationFrame(W)},B=async()=>{L.update(),L.health>=0&&setTimeout(B,1e3/60)};W();B();
